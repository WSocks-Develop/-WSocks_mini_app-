<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WSocks VPN</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.7.2/dist/axios.min.js"></script>
  <script src="https://unpkg.com/@twa-dev/sdk@7.10.0/dist/telegram-web-apps.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=stylesheet" rel="stylesheet">
  <script>
    // Заглушка для texts.js
    window.TEXTS = {
      setup: {
        manualPC: {
          title: 'Настройка для ПК',
          content: (sub) => `Инструкция для настройки на ПК с email: ${sub.email}`
        },
        manualAndroid: {
          title: 'Настройка для Android',
          content: 'Инструкция для настройки на Android'
        },
        manualIOS: {
          title: 'Настройка для iOS',
          content: 'Инструкция для настройки на iOS'
        },
        manualAndroidTV: {
          title: 'Настройка для Android TV',
          content: (sub) => `Инструкция для настройки на Android TV с email: ${sub.email}`
        }
      },
      terms: {
        title: 'Пользовательское соглашение',
        content: 'Текст пользовательского соглашения'
      }
    };
  </script>
  <style>
    /* CSS Custom Properties for Themes */
    :root[data-theme="dark"] {
      --background-color: #1a1a1a;
      --text-color: #ffffff;
      --card-bg: rgba(255, 255, 255, 0.1);
      --header-bg: #000000;
      --button-primary-bg: rgba(0, 191, 255, 0.8);
      --button-primary-hover-bg: rgba(0, 191, 255, 1);
      --accent-color: #00bfff;
      --button-secondary-bg: rgba(255, 255, 255, 0.2);
      --button-secondary-hover-bg: rgba(255, 255, 255, 0.3);
      --button-danger-bg: #ff0000;
      --button-danger-hover-bg: #cc0000;
      --shadow-color: rgba(0, 191, 255, 0.5);
      --button-glow: 0 0 15px rgba(0, 191, 255, 0.7);
    }

    /* Общие стили */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--background-color);
      color: var(--text-color);
      overflow-x: hidden;
      background-attachment: fixed;
    }

    .container {
      max-width: min(90vw, 1200px);
      margin: 0 auto;
      min-height: 100vh;
      background-color: transparent;
      box-shadow: 0 0 10px var(--shadow-color);
      position: relative;
      padding: 16px;
    }

    .header {
      position: sticky;
      top: 0;
      background-color: var(--header-bg);
      color: var(--text-color);
      padding: 16px;
      display: flex;
      align-items: center;
      z-index: 10;
      font-weight: 700;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .header-title {
      flex: 1;
      font-size: clamp(24px, 4vw, 32px);
      text-align: center;
      text-shadow: 0 0 5px var(--accent-color);
    }

    .content {
      padding: 16px 0;
    }

    .card {
      background: var(--card-bg);
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px var(--shadow-color);
      transition: box-shadow 0.3s ease;
    }

    .card:hover {
      box-shadow: 0 0 20px var(--shadow-color);
    }

    .card p {
      font-size: clamp(14px, 2.5vw, 16px);
      margin: 10px 0;
    }

    .card b {
      color: var(--text-color);
      font-weight: 700;
    }

    .button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 16px;
      margin-bottom: 12px;
      border: none;
      border-radius: 10px;
      font-size: clamp(16px, 2.5vw, 18px);
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.1s, box-shadow 0.3s;
      font-family: 'Inter', sans-serif;
      background-color: var(--button-primary-bg);
      box-shadow: var(--button-glow);
      opacity: 0;
      animation: scaleFadeIn 0.5s ease-out forwards;
    }

    .button:nth-child(1) { animation-delay: 0.1s; }
    .button:nth-child(2) { animation-delay: 0.3s; }
    .button:nth-child(3) { animation-delay: 0.5s; }
    .button:nth-child(4) { animation-delay: 0.7s; }

    .button:disabled {
      cursor: not-allowed;
      pointer-events: none;
      opacity: 0.5;
    }

    .button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 0 25px var(--shadow-color);
      background-color: var(--button-primary-hover-bg);
    }

    .button:active:not(:disabled) {
      transform: scale(0.95);
    }

    .button-square {
      aspect-ratio: 1/1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      background: var(--button-primary-bg);
      color: var(--text-color);
      font-size: clamp(14px, 2.5vw, 16px);
      text-align: center;
      overflow-wrap: break-word;
      white-space: normal;
      line-height: 1.2;
      max-height: 2.4em;
      opacity: 0;
      animation: scaleFadeIn 0.5s ease-out forwards;
    }

    .button-square:nth-child(1) { animation-delay: 0.1s; }
    .button-square:nth-child(2) { animation-delay: 0.3s; }
    .button-square:nth-child(3) { animation-delay: 0.5s; }
    .button-square:nth-child(4) { animation-delay: 0.7s; }

    .button-square span {
      flex-shrink: 1;
    }

    .button-square:hover:not(:disabled) {
      background: var(--button-primary-hover-bg);
      transform: translateY(-2px);
      box-shadow: 0 0 25px var(--shadow-color);
    }

    .button-square .icon {
      width: clamp(180px, 40vw, 200px);
      height: clamp(1080px, 240vw, 1200px);
      max-width: 133px;
      max-height: 798px;
    }

    .button-square .icon svg {
      width: 100%;
      height: 100%;
      fill: var(--text-color);
    }

    .button-secondary {
      background: var(--button-secondary-bg);
      color: var(--text-color);
    }

    .button-secondary:hover:not(:disabled) {
      background: var(--button-secondary-hover-bg);
    }

    .button-danger {
      background: var(--button-danger-bg);
      color: #ffffff;
    }

    .button-danger:hover:not(:disabled) {
      background: var(--button-danger-hover-bg);
    }

    .button-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .error {
      color: var(--button-danger-bg);
      font-size: clamp(14px, 2.5vw, 16px);
      text-align: center;
      margin-bottom: 20px;
    }

    .link {
      color: var(--accent-color);
      text-decoration: none;
      font-weight: 700;
    }

    .link:hover {
      text-decoration: underline;
    }

    .tooltip {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    .tooltip .tooltip-text {
      visibility: hidden;
      background-color: var(--header-bg);
      color: var(--text-color);
      text-align: center;
      border-radius: 6px;
      padding: 6px 10px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      font-size: clamp(12px, 2vw, 14px);
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    .clickable {
      color: var(--accent-color);
      cursor: pointer;
      font-weight: 700;
    }

    .clickable:hover {
      text-decoration: underline;
    }

    /* Анимации */
    @keyframes scaleFadeIn {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Адаптивность */
    @media (max-width: 600px) {
      .container {
        max-width: 100%;
        padding: 8px;
      }

      .header {
        padding: 12px;
      }

      .header-title {
        font-size: clamp(20px, 4vw, 24px);
      }

      .button {
        font-size: clamp(14px, 2.5vw, 16px);
        padding: 12px;
      }

      .button-square {
        font-size: clamp(12px, 3vw, 14px);
        padding: 8px;
      }

      .button-square .icon {
        width: clamp(160px, 35vw, 180px);
        height: clamp(960px, 210vw, 1080px);
        max-width: 133px;
        max-height: 798px;
      }

      .button-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }
    }

    @media (min-width: 1200px) {
      .container {
        max-width: min(80vw, 1400px);
      }

      .header-title {
        font-size: clamp(28px, 3vw, 36px);
      }

      .button {
        font-size: clamp(18px, 2vw, 20px);
        padding: 18px;
      }

      .button-square {
        font-size: clamp(16px, 2.8vw, 18px);
        padding: 10px;
      }

      .button-square .icon {
        width: clamp(80px, 12vw, 100px);
        height: clamp(480px, 72vw, 600px);
        max-width: 60px;
        max-height: 360px;
      }

      .button-grid {
        gap: 16px;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/javascript">
    const { useState, useEffect, createElement: h } = React;

    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    function App() {
      const [user, setUser] = useState(null);
      const [view, setView] = useState('main');
      const [subscriptions, setSubscriptions] = useState([]);
      const [referrals, setReferrals] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [paymentData, setPaymentData] = useState(() => {
        const saved = localStorage.getItem('paymentData');
        return saved ? JSON.parse(saved) : null;
      });
      const [selectedSub, setSelectedSub] = useState(() => {
        const saved = localStorage.getItem('selectedSub');
        return saved ? JSON.parse(saved) : null;
      });
      const [selectedReferee, setSelectedReferee] = useState(null);
      const [processingActions, setProcessingActions] = useState({});
      const [isSubscriptionsVisible, setIsSubscriptionsVisible] = useState(false);

      const API_URL = 'https://wsocks-api-bot-git.onrender.com';
      const SUPPORT_LINK = 'https://t.me/WSocks_Support';
      const SUPPORT_HANDLE = '@WSocks_Support';
      const BOT_USERNAME = '@YourBot';

      const axiosInstance = axios.create({ timeout: 0 });

      useEffect(() => {
        localStorage.setItem('view', view);
        localStorage.setItem('paymentData', JSON.stringify(paymentData));
        localStorage.setItem('selectedSub', JSON.stringify(selectedSub));
      }, [view, paymentData, selectedSub]);

      useEffect(() => {
        console.log('Приложение запускается...');
        if (!window.Telegram || !window.Telegram.WebApp) {
          setError('Telegram Web App SDK не загружен');
          setLoading(false);
          return;
        }

        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        const initData = Telegram.WebApp.initData;
        console.log('InitData:', initData);

        if (!initData) {
          setError('Не удалось получить initData');
          setLoading(false);
          return;
        }

        setLoading(true);
        axiosInstance.post(`${API_URL}/api/auth`, { init_data: initData }, {
          headers: { 'Cache-Control': 'no-cache' }
        })
          .then(({ data }) => {
            console.log('Ответ авторизации:', data);
            setUser(data.user);
            setLoading(false);
          })
          .catch(err => {
            console.error('Ошибка авторизации:', err);
            setError(`Ошибка авторизации: ${err.response?.data?.detail || err.message}`);
            setLoading(false);
          });
      }, []);

      const fetchSubscriptions = async () => {
        if (!user) {
          setError('Пользователь не авторизован');
          return;
        }
        setLoading(true);
        setError(null);
        try {
          const response = await axiosInstance.get(`${API_URL}/api/subscriptions?tg_id=${user.telegram_id}`, {
            headers: { 'Cache-Control': 'no-cache' }
          });
          console.log('Ответ подписок:', response.data);
          setSubscriptions(response.data.subscriptions || []);
          setView('subscriptions');
        } catch (err) {
          console.error('Ошибка подписок:', err);
          setError(`Ошибка получения подписок: ${err.response?.data?.detail || err.message}`);
        } finally {
          setLoading(false);
        }
      };

      const fetchReferrals = async () => {
        if (!user) {
          setError('Пользователь не авторизован');
          return;
        }
        setLoading(true);
        setError(null);
        try {
          const response = await axiosInstance.get(`${API_URL}/api/referrals?tg_id=${user.telegram_id}`, {
            headers: { 'Cache-Control': 'no-cache' }
          });
          console.log('Ответ рефералов:', response.data);
          setReferrals(response.data.referrals || []);
          setView('referrals');
        } catch (err) {
          console.error('Ошибка рефералов:', err);
          setError(`Ошибка получения рефералов: ${err.response?.data?.detail || err.message}`);
        } finally {
          setLoading(false);
        }
      };

      const activateSubscription = debounce(async (days, isExtension = false, email = null, requestId) => {
        if (!user) {
          setError('Пользователь не авторизован');
          return;
        }
        if (processingActions[requestId]) {
          return;
        }
        setProcessingActions(prev => ({ ...prev, [requestId]: true }));
        setLoading(true);
        setError(null);
        try {
          const endpoint = isExtension ? '/api/extend-subscription' : '/api/buy-subscription';
          const payload = isExtension 
            ? { tg_id: user.telegram_id, days, email }
            : { tg_id: user.telegram_id, days };
          const response = await axiosInstance.post(`${API_URL}${endpoint}`, payload);
          console.log('Ответ подписки:', response.data);
          setPaymentData({ ...response.data, isExtension });
          setView('payment');
        } catch (err) {
          console.error('Ошибка активации подписки:', err);
          setError(`Ошибка активации подписки: ${err.response?.data?.detail || err.message}`);
        } finally {
          setLoading(false);
          setProcessingActions(prev => ({ ...prev, [requestId]: false }));
        }
      }, 500);

      const activateTrial = debounce(async () => {
        if (!user) {
          setError('Пользователь не авторизован');
          return;
        }
        const requestId = generateRequestId();
        if (processingActions[requestId]) {
          return;
        }
        setProcessingActions(prev => ({ ...prev, [requestId]: true }));
        setLoading(true);
        setError(null);
        try {
          const response = await axiosInstance.post(`${API_URL}/api/activate-trial`, { tg_id: user.telegram_id });
          console.log('Ответ пробной подписки:', response.data);
          await fetchSubscriptions();
          Telegram.WebApp.showAlert(`Пробная подписка активирована на 3 дня до ${response.data.expiry_date}!`);
        } catch (err) {
          console.error('Ошибка активации пробной подписки:', err);
          Telegram.WebApp.showAlert(err.response?.data?.detail || 'Ошибка активации пробной подписки');
        } finally {
          setLoading(false);
          setProcessingActions(prev => ({ ...prev, [requestId]: false }));
        }
      }, 500);

      const applyReferralBonus = debounce(async (referee_id, email = null) => {
        if (!user) {
          setError('Пользователь не авторизован');
          return;
        }
        const requestId = generateRequestId();
        if (processingActions[requestId]) {
          return;
        }
        setProcessingActions(prev => ({ ...prev, [requestId]: true }));
        setLoading(true);
        setError(null);
        try {
          const nonTrialSubs = subscriptions.filter(sub => !sub.email.startsWith('DE-FRA-TRIAL-'));
          if (nonTrialSubs.length > 1 && !email) {
            setSelectedReferee(referee_id);
            setView('selectsubscription');
            return;
          }
          const payload = { tg_id: user.telegram_id, referee_id, email };
          const response = await axiosInstance.post(`${API_URL}/api/apply-referral-bonus`, payload);
          console.log('Ответ реферального бонуса:', response.data);
          await fetchSubscriptions();
          await fetchReferrals();
          Telegram.WebApp.showAlert(
            response.data.email.startsWith('DE-FRA-USER-')
              ? `Реферальная подписка активирована на 7 дней до ${response.data.expiry_date}!`
              : `Подписка продлена на 7 дней до ${response.data.expiry_date}!`
          );
        } catch (err) {
          console.error('Ошибка применения реферального бонуса:', err);
          setError(`Ошибка применения реферального бонуса: ${err.response?.data?.detail || err.message}`);
        } finally {
          setLoading(false);
          setProcessingActions(prev => ({ ...prev, [requestId]: false }));
        }
      }, 500);

      const confirmActivation = async () => {
        if (!user || !paymentData) {
          setError('Данные для активации отсутствуют');
          return;
        }
        setLoading(true);
        setError(null);
        try {
          setView('subscriptions');
          await fetchSubscriptions();
          Telegram.WebApp.showAlert(
            paymentData.isExtension 
              ? `Подписка успешно продлена на ${paymentData.days} дней до ${paymentData.expiry_date}!` 
              : `Подписка успешно активирована на ${paymentData.days} дней до ${paymentData.expiry_date}!`
          );
          setPaymentData(null);
          localStorage.removeItem('paymentData');
        } catch (err) {
          console.error('Ошибка подтверждения активации:', err);
          setError(`Ошибка подтверждения активации: ${err.message}`);
        } finally {
          setLoading(false);
        }
      };

      const handleRetry = (action) => {
        setError(null);
        action();
      };

      const generateRequestId = () => {
        return `${Date.now()}_${Math.random().toString(36).substring(2, 11)}`;
      };

      const copyToClipboard = (text) => {
        navigator.clipboard.writeText(text).then(() => {
          Telegram.WebApp.showAlert('Ссылка скопирована!');
        }).catch(err => {
          console.error('Ошибка копирования:', err);
          Telegram.WebApp.showAlert('Не удалось скопировать текст');
        });
      };

      const Header = ({ title, onBack }) => {
        const children = [];
        if (onBack) {
          children.push(h('button', { className: 'back-button', onClick: onBack, disabled: loading }, '←'));
        }
        children.push(h('div', { className: 'header-title' }, title));
        if (onBack) {
          children.push(h('div', { style: { width: '40px' } }));
        }
        return h('div', { className: 'header' }, children);
      };

      const UserInfo = () => {
        const toggleSubscriptions = () => setIsSubscriptionsVisible(!isSubscriptionsVisible);
        const children = [
          h('p', null, [h('b', null, 'Имя: '), user.first_name]),
          h('p', null, [h('b', null, 'Количество рефералов: '), referrals.length]),
          h('div', { className: 'clickable', onClick: toggleSubscriptions }, isSubscriptionsVisible ? 'Скрыть подписки' : 'Показать подписки')
        ];

        if (isSubscriptionsVisible) {
          if (subscriptions.length === 0) {
            children.push(h('p', { className: 'card' }, 'Нет активных подписок'));
          } else {
            subscriptions.forEach((sub, index) => {
              children.push(
                h('div', { key: index, className: 'card' }, [
                  h('p', null, [h('b', null, 'Email: '), sub.email]),
                  h('p', null, [h('b', null, 'Панель: '), sub.panel]),
                  h('p', null, [h('b', null, 'Дата окончания: '), new Date(sub.expiry_date).toLocaleString()]),
                  h('p', null, [h('b', null, 'Статус: '), sub.is_expired ? 'Заблокировано' : 'Активна'])
                ])
              );
            });
          }
        }

        return h('div', { className: 'card' }, children);
      };

      const renderMainMenu = () => {
        const contentChildren = [];

        if (user) {
          contentChildren.push(h(UserInfo));
        }

        if (error) {
          contentChildren.push(
            h('p', { className: 'error' }, error),
            h('button', { className: 'button button-primary', onClick: () => window.location.reload() }, 'Повторить'),
            h('button', { className: 'button button-danger', onClick: () => Telegram.WebApp.close() }, 'Закрыть приложение')
          );
        } else {
          contentChildren.push(
            h('div', { className: 'button-grid' }, [
              h('div', { className: 'tooltip' }, [
                h('button', { className: 'button button-square', onClick: fetchReferrals, disabled: loading }, [
                  h('span', { className: 'icon' }, [
                    h('svg', { viewBox: '0 0 24 24' }, [
                      h('path', { d: 'M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z' }),
                      h('path', { d: 'M20 12c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.67 0-5 1.34-5 4v2h4v-2c0-1.66 3.34-4 5-4z' })
                    ])
                  ]),
                  h('span', null, 'Реферальная система')
                ]),
                h('span', { className: 'tooltip-text' }, 'Приглашайте друзей и получайте бонусы')
              ]),
              h('div', { className: 'tooltip' }, [
                h('button', { className: 'button button-square', onClick: fetchSubscriptions, disabled: loading }, [
                  h('span', { className: 'icon' }, [
                    h('svg', { viewBox: '0 0 24 24' }, [
                      h('path', { d: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm4.59-12.42L10 14.17l-2.59-2.58L6 13l4 4 8-8z' })
                    ])
                  ]),
                  h('span', null, 'Подписки')
                ]),
                h('span', { className: 'tooltip-text' }, 'Управление вашими подписками')
              ]),
              h('div', { className: 'tooltip' }, [
                h('button', { className: 'button button-square', onClick: () => setView('info'), disabled: loading }, [
                  h('span', { className: 'icon' }, [
                    h('svg', { viewBox: '0 0 24 24' }, [
                      h('path', { d: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z' })
                    ])
                  ]),
                  h('span', null, 'Информация')
                ]),
                h('span', { className: 'tooltip-text' }, 'Узнайте больше о WSocks VPN')
              ]),
              h('div', { className: 'tooltip' }, [
                h('button', { className: 'button button-square', onClick: () => setView('support'), disabled: loading }, [
                  h('span', { className: 'icon' }, [
                    h('svg', { viewBox: '0 0 24 24' }, [
                      h('path', { d: 'M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 9h-2V5h2v6zm0 4h-2v-2h2v2z' })
                    ])
                  ]),
                  h('span', null, 'Поддержка Telegram')
                ]),
                h('span', { className: 'tooltip-text' }, 'Свяжитесь с нашей поддержкой')
              ])
            ])
          );
        }

        return h('div', { className: 'container' }, [
          Header({ title: 'WSocks VPN' }),
          h('div', { className: 'content' }, contentChildren)
        ]);
      };

      const renderSupport = () => {
        const contentChildren = [];

        if (error) {
          contentChildren.push(
            h('p', { className: 'error' }, error),
            h('button', { className: 'button button-primary', onClick: () => handleRetry(() => setView('support')) }, 'Повторить'),
            h('button', { className: 'button button-secondary', onClick: () => setView('main') }, 'Назад')
          );
        } else {
          contentChildren.push(
            h('div', { className: 'card' }, [
              h('p', null, 'Для связи с нашей поддержкой отправьте сообщение сюда, и наша команда ответит вам в ближайшее время!'),
              h('p', null, 'Ваш id в телеграмм: ', h('span', { className: 'clickable', onClick: () => copyToClipboard(user.telegram_id) }, user.telegram_id)),
              h('p', { style: { fontStyle: 'italic' } }, '(нажмите на id чтобы скопировать)')
            ]),
            h('button', { className: 'button button-secondary', onClick: () => setView('main'), disabled: loading }, 'Назад')
          );
        }

        return h('div', { className: 'container' }, [
          Header({ title: 'Поддержка', onBack: () => setView('main') }),
          h('div', { className: 'content' }, contentChildren)
        ]);
      };

      const renderReferrals = () => {
        const contentChildren = [];

        if (error) {
          contentChildren.push(
            h('p', { className: 'error' }, error),
            h('button', { className: 'button button-primary', onClick: () => handleRetry(fetchReferrals) }, 'Повторить'),
            h('button', { className: 'button button-secondary', onClick: () => setView('main') }, 'Назад')
          );
        } else {
          contentChildren.push(
            h('p', { className: 'card' }, 'Приглашайте друзей и получайте бонусы:')
          );

          if (user) {
            contentChildren.push(
              h('div', { className: 'card' }, [
                h('p', null, 'Ваша реферальная ссылка: ', h('span', { className: 'clickable', onClick: () => copyToClipboard(`${BOT_USERNAME}?start=ref_${user.telegram_id}`) }, `${BOT_USERNAME}?start=ref_${user.telegram_id}`)),
                h('p', { style: { fontStyle: 'italic' } }, '(нажмите на ссылку чтобы скопировать)')
              ])
            );
          }

          if (referrals.length === 0) {
            contentChildren.push(h('p', { className: 'card' }, 'У вас пока нет рефералов.'));
          } else {
            referrals.forEach((ref, index) => {
              const cardChildren = [
                h('p', null, [h('b', null, 'ID реферала: '), ref.referee_id])
              ];
              if (ref.bonus_applied) {
                cardChildren.push(
                  h('p', null, [h('b', null, 'Бонус получен: '), new Date(ref.bonus_date).toLocaleString()])
                );
              } else {
                cardChildren.push(
                  h('button', { className: 'button button-primary', onClick: () => applyReferralBonus(ref.referee_id), disabled: loading }, 'Получить бонус')
                );
              }
              contentChildren.push(h('div', { key: index, className: 'card' }, cardChildren));
            });
          }

          contentChildren.push(
            h('button', { className: 'button button-secondary', onClick: () => setView('main'), disabled: loading }, 'Назад')
          );
        }

        return h('div', { className: 'container' }, [
          Header({ title: 'Реферальная система', onBack: () => setView('main') }),
          h('div', { className: 'content' }, contentChildren)
        ]);
      };

      const renderSubscriptions = () => {
        const contentChildren = [];

        if (error) {
          contentChildren.push(
            h('p', { className: 'error' }, error),
            h('button', { className: 'button button-primary', onClick: () => handleRetry(fetchSubscriptions) }, 'Повторить'),
            h('button', { className: 'button button-secondary', onClick: () => setView('main') }, 'Назад')
          );
        } else {
          if (subscriptions.length === 0) {
            contentChildren.push(h('p', { className: 'card' }, 'Нет активных подписок.'));
          } else {
            subscriptions.forEach((sub, index) => {
              const cardChildren = [
                h('p', null, [h('b', null, 'Email: '), sub.email]),
                h('p', null, [h('b', null, 'Панель: '), sub.panel]),
                h('p', null, [h('b', null, 'Дата окончания: '), new Date(sub.expiry_date).toLocaleString()]),
                h('p', null, [h('b', null, 'Статус: '), sub.is_expired ? 'Заблокировано' : 'Активна']),
                h('div', { style: { display: 'flex', gap: '12px', marginTop: '12px' } }, [
                  !sub.email.startsWith('DE-FRA-TRIAL-') ? h('button', { className: 'button button-primary', onClick: () => { setSelectedSub(sub); setView('extend'); }, disabled: loading }, 'Продлить') : null,
                  h('button', { className: 'button button-primary', onClick: () => { setSelectedSub(sub); setView('setup'); }, disabled: loading }, 'Настройка')
                ])
              ];
              contentChildren.push(h('div', { key: index, className: 'card' }, cardChildren));
            });
          }

          contentChildren.push(
            h('div', { className: 'tooltip' }, [
              h('button', { className: 'button button-primary', onClick: activateTrial, disabled: loading }, 'Пробная подписка'),
              h('span', { className: 'tooltip-text' }, 'Активируйте бесплатную подписку на 3 дня')
            ]),
            h('button', { className: 'button button-primary', onClick: () => setView('buy'), disabled: loading }, 'Купить подписку'),
            h('button', { className: 'button button-secondary', onClick: () => setView('main'), disabled: loading }, 'Назад')
          );
        }

        return h('div', { className: 'container' }, [
          Header({ title: 'Подписки', onBack: () => setView('main') }),
          h('div', { className: 'content' }, contentChildren)
        ]);
      };

      const renderBuy = () => {
        const contentChildren = [];

        if (error) {
          contentChildren.push(
            h('p', { className: 'error' }, error),
            h('button', { className: 'button button-primary', onClick: () => handleRetry(() => activateSubscription(30, false, null, generateRequestId())) }, 'Повторить'),
            h('button', { className: 'button button-secondary', onClick: () => setView('subscriptions') }, 'Назад')
          );
        } else {
          contentChildren.push(
            h('button', { className: 'button button-primary', onClick: () => activateSubscription(30, false, null, generateRequestId()), disabled: loading || processingActions['buy-30'] }, '30 дней'),
            h('button', { className: 'button button-primary', onClick: () => activateSubscription(90, false, null, generateRequestId()), disabled: loading || processingActions['buy-90'] }, '90 дней'),
            h('button', { className: 'button button-primary', onClick: () => activateSubscription(180, false, null, generateRequestId()), disabled: loading || processingActions['buy-180'] }, '180 дней'),
            h('button', { className: 'button button-primary', onClick: () => activateSubscription(360, false, null, generateRequestId()), disabled: loading || processingActions['buy-360'] }, '360 дней'),
            h('button', { className: 'button button-secondary', onClick: () => setView('subscriptions'), disabled: loading }, 'Назад')
          );
        }

        return h('div', { className: 'container' }, [
          Header({ title: 'Купить подписку', onBack: () => setView('subscriptions') }),
          h('div', { className: 'content' }, contentChildren)
        ]);
      };

      const renderExtend = () => {
        const contentChildren = [];

        if (error) {
          contentChildren.push(
            h('p', { className: 'error' }, error),
            h('button', { className: 'button button-primary', onClick: () => handleRetry(() => activateSubscription(30, true, selectedSub.email, generateRequestId())) }, 'Повторить'),
            h('button', { className: 'button button-secondary', onClick: () => setView('subscriptions') }, 'Назад')
          );
        } else {
          if (selectedSub) {
            contentChildren.push(
              h('p', { className: 'card' }, [h('b', null, 'Email: '), selectedSub.email]),
              h('p', { className: 'card' }, [h('b', null, 'Текущая дата окончания: '), new Date(selectedSub.expiry_date).toLocaleString()])
            );
          }
          contentChildren.push(
            h('button', { className: 'button button-primary', onClick: () => activateSubscription(30, true, selectedSub ? selectedSub.email : null, generateRequestId()), disabled: loading || processingActions['extend-30'] }, 'Продлить на 30 дней'),
            h('button', { className: 'button button-primary', onClick: () => activateSubscription(90, true, selectedSub ? selectedSub.email : null, generateRequestId()), disabled: loading || processingActions['extend-90'] }, 'Продлить на 90 дней'),
            h('button', { className: 'button button-primary', onClick: () => activateSubscription(180, true, selectedSub ? selectedSub.email : null, generateRequestId()), disabled: loading || processingActions['extend-180'] }, 'Продлить на 180 дней'),
            h('button', { className: 'button button-primary', onClick: () => activateSubscription(360, true, selectedSub ? selectedSub.email : null, generateRequestId()), disabled: loading || processingActions['extend-360'] }, 'Продлить на 360 дней'),
            h('button', { className: 'button button-secondary', onClick: () => setView('subscriptions'), disabled: loading }, 'Назад')
          );
        }

        return h('div', { className: 'container' }, [
          Header({ title: 'Продлить подписку', onBack: () => setView('subscriptions') }),
          h('div', { className: 'content' }, contentChildren)
        ]);
      };

      const renderSelectSubscription = () => {
        const contentChildren = [];

        if (error) {
          contentChildren.push(
            h('p', { className: 'error' }, error),
            h('button', { className: 'button button-primary', onClick: () => handleRetry(() => applyReferralBonus(selectedReferee)) }, 'Повторить'),
            h('button', { className: 'button button-secondary', onClick: () => setView('referrals') }, 'Назад')
          );
        } else {
          contentChildren.push(h('p', { className: 'card' }, 'Выберите подписку для продления на 7 дней:'));
          const nonTrialSubs = subscriptions.filter(sub => !sub.email.startsWith('DE-FRA-TRIAL-'));
          nonTrialSubs.forEach((sub, index) => {
            contentChildren.push(
              h('div', { key: index, className: 'card' }, [
                h('p', null, [h('b', null, 'Email: '), sub.email]),
                h('p', null, [h('b', null, 'Панель: '), sub.panel]),
                h('p', null, [h('b', null, 'Дата окончания: '), new Date(sub.expiry_date).toLocaleString()]),
                h('button', { className: 'button button-primary', onClick: () => applyReferralBonus(selectedReferee, sub.email), disabled: loading }, 'Продлить на 7 дней')
              ])
            );
          });
          contentChildren.push(h('button', { className: 'button button-secondary', onClick: () => setView('referrals'), disabled: loading }, 'Назад'));
        }

        return h('div', { className: 'container' }, [
          Header({ title: 'Выберите подписку', onBack: () => setView('referrals') }),
          h('div', { className: 'content' }, contentChildren)
        ]);
      };

      const renderPayment = () => {
        const contentChildren = [];

        if (error) {
          contentChildren.push(
            h('p', { className: 'error' }, error),
            h('button', { className: 'button button-primary', onClick: () => handleRetry(confirmActivation) }, 'Повторить'),
            h('button', { className: 'button button-secondary', onClick: () => { setPaymentData(null); localStorage.removeItem('paymentData'); setView('subscriptions'); } }, 'Назад')
          );
        } else if (paymentData) {
          contentChildren.push(
            h('p', { className: 'card' }, `Подписка на ${paymentData.days} дней`),
            h('p', { className: 'card' }, [h('b', null, 'Пользователь: '), paymentData.email]),
            h('p', { className: 'card' }, [h('b', null, 'Дата окончания: '), new Date(paymentData.expiry_date).toLocaleString()]),
            h('button', { className: 'button button-primary', onClick: confirmActivation, disabled: loading }, 'Подтвердить'),
            h('button', { className: 'button button-danger', onClick: () => { setPaymentData(null); localStorage.removeItem('paymentData'); setView('subscriptions'); }, disabled: loading }, 'Отмена')
          );
        }

        return h('div', { className: 'container' }, [
          Header({ title: 'Подтверждение подписки', onBack: () => { setPaymentData(null); localStorage.removeItem('paymentData'); setView('subscriptions'); } }),
          h('div', { className: 'content' }, contentChildren)
        ]);
      };

      const renderSetup = () => {
        const contentChildren = [];

        if (error) {
          contentChildren.push(
            h('p', { className: 'error' }, error),
            h('button', { className: 'button button-primary', onClick: () => handleRetry(() => setView('setup')) }, 'Повторить'),
            h('button', { className: 'button button-secondary', onClick: () => setView('subscriptions') }, 'Назад')
          );
        } else {
          if (selectedSub) {
            contentChildren.push(h('p', { className: 'card' }, [h('b', null, 'Email: '), selectedSub.email]));
          }
          contentChildren.push(
            h('button', { className: 'button button-primary', onClick: () => setView('manualPC'), disabled: loading }, 'Настройка для ПК'),
            h('button', { className: 'button button-primary', onClick: () => setView('manualAndroid'), disabled: loading }, 'Настройка для Android'),
            h('button', { className: 'button button-primary', onClick: () => setView('manualIOS'), disabled: loading }, 'Настройка для iOS'),
            h('button', { className: 'button button-primary', onClick: () => setView('manualAndroidTV'), disabled: loading }, 'Настройка для Android TV'),
            h('button', { className: 'button button-secondary', onClick: () => setView('subscriptions'), disabled: loading }, 'Назад')
          );
        }

        return h('div', { className: 'container' }, [
          Header({ title: 'Настройка', onBack: () => setView('subscriptions') }),
          h('div', { className: 'content' }, contentChildren)
        ]);
      };

      const renderManualPC = () => {
        const contentChildren = [];

        if (error) {
          contentChildren.push(
            h('p', { className: 'error' }, error),
            h('button', { className: 'button button-primary', onClick: () => handleRetry(() => setView('manualPC')) }, 'Повторить'),
            h('button', { className: 'button button-secondary', onClick: () => setView('setup') }, 'Назад')
          );
        } else if (selectedSub) {
          contentChildren.push(
            h('div', { className: 'card' }, [
              h('div', { className: 'manual-content', dangerouslySetInnerHTML: { __html: window.TEXTS.setup.manualPC.content(selectedSub) } })
            ]),
            h('button', { className: 'button button-secondary', onClick: () => setView('setup'), disabled: loading }, 'Назад')
          );
        }

        return h('div', { className: 'container' }, [
          Header({ title: 'Настройка для ПК', onBack: () => setView('setup') }),
          h('div', { className: 'content' }, contentChildren)
        ]);
      };

      const renderManualAndroid = () => {
        const contentChildren = [];

        if (error) {
          contentChildren.push(
            h('p', { className: 'error' }, error),
            h('button', { className: 'button button-primary', onClick: () => handleRetry(() => setView('manualAndroid')) }, 'Повторить'),
            h('button', { className: 'button button-secondary', onClick: () => setView('setup') }, 'Назад')
          );
        } else {
          contentChildren.push(
            h('div', { className: 'card' }, [
              h('div', { className: 'manual-content', dangerouslySetInnerHTML: { __html: window.TEXTS.setup.manualAndroid.content } })
            ]),
            h('button', { className: 'button button-secondary', onClick: () => setView('setup'), disabled: loading }, 'Назад')
          );
        }

        return h('div', { className: 'container' }, [
          Header({ title: 'Настройка для Android', onBack: () => setView('setup') }),
          h('div', { className: 'content' }, contentChildren)
        ]);
      };

      const renderManualIOS = () => {
        const contentChildren = [];

        if (error) {
          contentChildren.push(
            h('p', { className: 'error' }, error),
            h('button', { className: 'button button-primary', onClick: () => handleRetry(() => setView('manualIOS')) }, 'Повторить'),
            h('button', { className: 'button button-secondary', onClick: () => setView('setup') }, 'Назад')
          );
        } else {
          contentChildren.push(
            h('div', { className: 'card' }, [
              h('div', { className: 'manual-content', dangerouslySetInnerHTML: { __html: window.TEXTS.setup.manualIOS.content } })
            ]),
            h('button', { className: 'button button-secondary', onClick: () => setView('setup'), disabled: loading }, 'Назад')
          );
        }

        return h('div', { className: 'container' }, [
          Header({ title: 'Настройка для iOS', onBack: () => setView('setup') }),
          h('div', { className: 'content' }, contentChildren)
        ]);
      };

      const renderManualAndroidTV = () => {
        const contentChildren = [];

        if (error) {
          contentChildren.push(
            h('p', { className: 'error' }, error),
            h('button', { className: 'button button-primary', onClick: () => handleRetry(() => setView('manualAndroidTV')) }, 'Повторить'),
            h('button', { className: 'button button-secondary', onClick: () => setView('setup') }, 'Назад')
          );
        } else if (selectedSub) {
          contentChildren.push(
            h('div', { className: 'card' }, [
              h('div', { className: 'manual-content', dangerouslySetInnerHTML: { __html: window.TEXTS.setup.manualAndroidTV.content(selectedSub) } })
            ]),
            h('button', { className: 'button button-secondary', onClick: () => setView('setup'), disabled: loading }, 'Назад')
          );
        }

        return h('div', { className: 'container' }, [
          Header({ title: 'Настройка для Android TV', onBack: () => setView('setup') }),
          h('div', { className: 'content' }, contentChildren)
        ]);
      };

      const renderInfo = () => {
        const contentChildren = [];

        if (error) {
          contentChildren.push(
            h('p', { className: 'error' }, error),
            h('button', { className: 'button button-primary', onClick: () => handleRetry(() => setView('info')) }, 'Повторить'),
            h('button', { className: 'button button-secondary', onClick: () => setView('main') }, 'Назад')
          );
        } else {
          contentChildren.push(
            h('button', { className: 'button button-primary', onClick: () => setView('service'), disabled: loading }, 'О сервисе'),
            h('button', { className: 'button button-primary', onClick: () => setView('subscription'), disabled: loading }, 'О подписке'),
            h('button', { className: 'button button-primary', onClick: () => setView('terms'), disabled: loading }, 'Пользовательское соглашение'),
            h('button', { className: 'button button-primary', onClick: () => setView('privacy'), disabled: loading }, 'Политика конфиденциальности'),
            h('button', { className: 'button button-secondary', onClick: () => setView('main'), disabled: loading }, 'Назад')
          );
        }

        return h('div', { className: 'container' }, [
          Header({ title: 'Информация', onBack: () => setView('main') }),
          h('div', { className: 'content' }, contentChildren)
        ]);
      };

      const renderService = () => {
        const contentChildren = [];

        if (error) {
          contentChildren.push(
            h('p', { className: 'error' }, error),
            h('button', { className: 'button button-primary', onClick: () => handleRetry(() => setView('service')) }, 'Повторить'),
            h('button', { className: 'button button-secondary', onClick: () => setView('info') }, 'Назад')
          );
        } else {
          contentChildren.push(
            h('div', { className: 'card' }, [
              h('p', null, 'Информация о сервисе.')
            ]),
            h('button', { className: 'button button-secondary', onClick: () => setView('info'), disabled: loading }, 'Назад')
          );
        }

        return h('div', { className: 'container' }, [
          Header({ title: 'О сервисе', onBack: () => setView('info') }),
          h('div', { className: 'content' }, contentChildren)
        ]);
      };

      const renderSubscription = () => {
        const contentChildren = [];

        if (error) {
          contentChildren.push(
            h('p', { className: 'error' }, error),
            h('button', { className: 'button button-primary', onClick: () => handleRetry(() => setView('subscription')) }, 'Повторить'),
            h('button', { className: 'button button-secondary', onClick: () => setView('info') }, 'Назад')
          );
        } else {
          contentChildren.push(
            h('div', { className: 'card' }, [
              h('p', null, [h('b', null, 'Информация:'), ' Описание подписки'])
            ]),
            h('button', { className: 'button button-secondary', onClick: () => setView('info'), disabled: loading }, 'Назад')
          );
        }

        return h('div', { className: 'container' }, [
          Header({ title: 'О подписке', onBack: () => setView('info') }),
          h('div', { className: 'content' }, contentChildren)
        ]);
      };

      const renderTerms = () => {
        const contentChildren = [];

        if (error) {
          contentChildren.push(
            h('p', { className: 'error' }, error),
            h('button', { className: 'button button-primary', onClick: () => handleRetry(() => setView('terms')) }, 'Повторить'),
            h('button', { className: 'button button-secondary', onClick: () => setView('info') }, 'Назад')
          );
        } else {
          contentChildren.push(
            h('div', { className: 'card' }, [
              h('div', { className: 'manual-content', dangerouslySetInnerHTML: { __html: window.TEXTS.terms.content } })
            ]),
            h('button', { className: 'button button-secondary', onClick: () => setView('info'), disabled: loading }, 'Назад')
          );
        }

        return h('div', { className: 'container' }, [
          Header({ title: 'Пользовательское соглашение', onBack: () => setView('info') }),
          h('div', { className: 'content' }, contentChildren)
        ]);
      };

      const renderPrivacy = () => {
        const contentChildren = [];

        if (error) {
          contentChildren.push(
            h('p', { className: 'error' }, error),
            h('button', { className: 'button button-primary', onClick: () => handleRetry(() => setView('privacy')) }, 'Повторить'),
            h('button', { className: 'button button-secondary', onClick: () => setView('info') }, 'Назад')
          );
        } else {
          contentChildren.push(
            h('p', { className: 'card' }, 'Информация о конфиденциальности.'),
            h('button', { className: 'button button-secondary', onClick: () => setView('info'), disabled: loading }, 'Назад')
          );
        }

        return h('div', { className: 'container' }, [
          Header({ title: 'Политика конфиденциальности', onBack: () => setView('info') }),
          h('div', { className: 'content' }, contentChildren)
        ]);
      };

      const views = {
        main: renderMainMenu,
        support: renderSupport,
        referrals: renderReferrals,
        subscriptions: renderSubscriptions,
        buy: renderBuy,
        extend: renderExtend,
        selectsubscription: renderSelectSubscription,
        payment: renderPayment,
        setup: renderSetup,
        manualPC: renderManualPC,
        manualAndroid: renderManualAndroid,
        manualIOS: renderManualIOS,
        manualAndroidTV: renderManualAndroidTV,
        info: renderInfo,
        service: renderService,
        subscription: renderSubscription,
        terms: renderTerms,
        privacy: renderPrivacy
      };

      const contentChildren = [];

      if (!user) {
        contentChildren.push(
          Header({ title: 'WSocks VPN' }),
          h('div', { className: 'content' }, [
            error ? h('p', { className: 'error' }, error) : null,
            error ? h('button', { className: 'button button-primary', onClick: () => window.location.reload() }, 'Повторить') : null,
            error ? h('button', { className: 'button button-danger', onClick: () => Telegram.WebApp.close() }, 'Закрыть приложение') : null,
            !error ? h('p', { className: 'card', style: { textAlign: 'center' } }, 'Загрузка данных пользователя...') : null
          ])
        );
      } else {
        contentChildren.push(views[view]());
      }

      return h('div', null, contentChildren);
    }

    ReactDOM.render(h(App), document.getElementById('root'));
  </script>
</body>
</html>
